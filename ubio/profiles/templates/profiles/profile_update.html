{% extends 'ubio/base.html' %}
{% load bootstrap4 %}

{% block title %}
Edit profile
{% endblock %}

{% block header %}
Edit profile
{% endblock %}

{% block body %}
  <div class="d-flex">
    <img src="{{ profile.avatar.url }}" alt="avatar" class="img-fluid rounded-circle" style="max-width: 128px; max-height: 128px;">

    <div class="d-flex flex-column justify-content-between ml-4 py-3">
      <form action="{% url 'profile-update' pk=profile.pk %}" method="GET" id="fileForm"
            data-target="{%  url 'avatar-update' pk=profile.pk %}">
        <button class="btn btn-outline-secondary ubio-file-input">
          <input type="file" value="Choose file..." accept="image/*" >
          Change profile image
        </button>
      </form>
      <form action="{% url 'avatar-delete' pk=profile.pk %}" method="POST">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger">Delete profile image</button>
      </form>
    </div>
  </div>

  <hr>

  <div class="d-flex mt-4">
    <form action="" method="POST" class="flex-fill">
      {% bootstrap_messages %}
      {% csrf_token %}
      {% bootstrap_form form %}
      <input type="submit" value="Save" class="btn btn-outline-primary">
    </form>
  </div>
{% endblock %}



{% block script %}
{% csrf_token %}
<script>
const form = $('#fileForm');
form.find('input[type="file"]').change(function (event) {
  // `this` is an <input type="file"> (not a jQuery object, plain DOM!)
  var input = this;
  if (input.files && input.files[0]) {
    var sizeKb = (input.files[0].size / 1024).toFixed(4);
    console.log(sizeKb);
    if (sizeKb > 500) {
      Swal.fire({
        type: 'warning',
        text: `Profile image size must be under 500KB, your file is ${sizeKb}KB`,
        customClass: {
          confirmButton: 'btn btn-outline-secondary mx-2',
        },
        buttonsStyling: false
      });
    } else {
      var data = new FormData(form.get(0));
      var reader = new FileReader();
      reader.onload = function (re) {
        Swal.fire({
          text: 'Use this as your profile picture?',
          imageUrl: re.target.result,
          imageWidth: 240,
          imageHeight: 240,
          imageAlt: 'new profile picture',
          animation: false,
          showCancelButton: true,
          cancelButtonText: 'No',
          confirmButtonText: 'Yes',
          customClass: {
            image: 'img-fluid rounded-circle',
            confirmButton: 'btn btn-success mx-2',
            cancelButton: 'btn btn-outline-secondary mx-2',
          },
          buttonsStyling: false
        }).then(result => {
          if (result.value) {
            var req = new XMLHttpRequest();
            req.open("POST", form.attr('data-target'), true);
            req.onload = function (xe) {
              form.submit();
            };
            data.append('avatar', re.target.result);
            data.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
            req.send(data);
          }
        });
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
  event.preventDefault();
});
</script>
{% endblock %}
